{% extends "base.html" %}
{% block title %} Анализ энергопотребления {% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Анализ энергопотребления</h1>

    <!-- Панель управления -->
    <div class="control-panel">
        <div class="select-panel">
            <label for="panelSelect">Выберите установку:</label>
            <select id="panelSelect">
                {% for panel in solar_panels %}
                <option value="{{ panel.id }}">Панель {{ panel.id }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="time-filters">
            <button id="day" class="btn">День</button>
            <button id="week" class="btn">Неделя</button>
            <button id="month" class="btn">Месяц</button>
            
            <div class="date-range">
                <label for="dateRangeInput">Выберите период:</label>
                <input type="text" id="dateRangeInput" name="dateRangeInput">
            </div>

            <div class="time-of-day">
                <label>Время суток:</label>
                <select id="timeFilter">
                    <option value="all">Весь день</option>
                    <option value="morning">Утро (6:00-12:00)</option>
                    <option value="afternoon">День (12:00-18:00)</option>
                    <option value="evening">Вечер (18:00-00:00)</option>
                    <option value="night">Ночь (00:00-6:00)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-container">
        <div class="chart-wrapper">
            <h2>Генерация и потребление энергии</h2>
            <canvas id="powerChart"></canvas>
        </div>
        
        <div class="chart-wrapper">
            <h2>Эффективность панелей</h2>
            <canvas id="efficiencyChart"></canvas>
        </div>
    </div>

    <!-- Статистика -->
    <div class="statistics">
        <h2>Статистические показатели</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Генерация</h3>
                <p>Среднее: <span id="avgGeneration">-</span> кВт</p>
                <p>Максимум: <span id="maxGeneration">-</span> кВт</p>
                <p>Минимум: <span id="minGeneration">-</span> кВт</p>
            </div>
            <div class="stat-card">
                <h3>Потребление</h3>
                <p>Среднее: <span id="avgConsumption">-</span> кВт</p>
                <p>Максимум: <span id="maxConsumption">-</span> кВт</p>
                <p>Минимум: <span id="minConsumption">-</span> кВт</p>
            </div>
            <div class="stat-card">
                <h3>Эффективность</h3>
                <p>Средняя: <span id="avgEfficiency">-</span>%</p>
                <p>Пиковая: <span id="peakEfficiency">-</span>%</p>
            </div>
        </div>
    </div>

    <!-- Кнопки управления -->
    <div class="actions">
        <button id="exportData" class="btn">Экспорт данных</button>
        <button id="showOverallStats" class="btn">Общая статистика</button>
    </div>
</div>

<!-- Inline стили (рекомендуется вынести в отдельный CSS-файл) -->
<style>
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.control-panel {
    margin-bottom: 30px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 8px;
}

.charts-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.chart-wrapper {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.statistics {
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    margin-right: 10px;
}

.btn:hover {
    background: #45a049;
}
</style>

<!-- Скрипты (рекомендуется вынести в отдельный JS-файл) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Кэширование DOM-элементов
    const panelSelect = document.getElementById('panelSelect');
    const exportDataBtn = document.getElementById('exportData');
    const powerChartCtx = document.getElementById('powerChart').getContext('2d');
    const efficiencyChartCtx = document.getElementById('efficiencyChart').getContext('2d');
    const dayBtn = document.getElementById('day');
    const weekBtn = document.getElementById('week');
    const monthBtn = document.getElementById('month');
    
    let currentData = {}; // Хранение последних полученных данных

    // Инициализация графика мощности
    const powerChart = new Chart(powerChartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Генерация',
                data: [],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: true
            }, {
                label: 'Потребление',
                data: [],
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Генерация и потребление энергии'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Мощность (кВт)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Время'
                    }
                }
            }
        }
    });

    // Инициализация графика эффективности
    const efficiencyChart = new Chart(efficiencyChartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Эффективность',
                data: [],
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Эффективность солнечных панелей'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Эффективность (%)'
                    }
                }
            }
        }
    });

    // Функция обновления графиков и статистики
    function updateCharts(data) {
        console.log("Получены данные:", data); // Для отладки
        if (!data || !data.date || !data.generated_power || !data.consumed_power) {
            console.error("Неверный формат данных:", data);
            return;
        }
        currentData = data;
        // Обновление данных графика мощности
        powerChart.data.labels = data.date;
        powerChart.data.datasets[0].data = data.generated_power;
        powerChart.data.datasets[1].data = data.consumed_power;
        powerChart.update();
        
        // Расчёт эффективности
        const efficiency = data.generated_power.map((gen, i) =>
            gen > 0 ? parseFloat((data.consumed_power[i] / gen * 100).toFixed(1)) : 0
        );
        
        // Обновление данных графика эффективности
        efficiencyChart.data.labels = data.date;
        efficiencyChart.data.datasets[0].data = efficiency;
        efficiencyChart.update();
        
        // Обновление статистики
        updateStatistics(data.generated_power, data.consumed_power, efficiency);
    }

    // Функция обновления статистических показателей
    function updateStatistics(generated, consumed, efficiency) {
        const avg = arr => arr.reduce((sum, val) => sum + Number(val), 0) / (arr.length || 1);
        const format = num => num.toFixed(2);
        
        document.getElementById('avgGeneration').textContent = format(avg(generated));
        document.getElementById('maxGeneration').textContent = format(Math.max(...generated));
        document.getElementById('minGeneration').textContent = format(Math.min(...generated));
        
        document.getElementById('avgConsumption').textContent = format(avg(consumed));
        document.getElementById('maxConsumption').textContent = format(Math.max(...consumed));
        document.getElementById('minConsumption').textContent = format(Math.min(...consumed));
        
        document.getElementById('avgEfficiency').textContent = format(avg(efficiency));
        document.getElementById('peakEfficiency').textContent = format(Math.max(...efficiency));
    }

    // Функция для выполнения запроса с выбранным диапазоном
    function fetchDataByRange(range) {
        // Получаем выбранные даты из daterangepicker
        const drp = $('#dateRangeInput').data('daterangepicker');
        const start = drp.startDate.format('YYYY-MM-DD');
        const end = drp.endDate.format('YYYY-MM-DD');
        
        // Формируем URL с параметрами для фильтрации
        const url = `/get-general-characteristics-data/?range=${range}&start=${start}&end=${end}`;
        console.log("Запрос по URL:", url);
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Ошибка при загрузке данных');
                return response.json();
            })
            .then(data => {
                console.log("Данные по диапазону:", data);
                updateCharts(data);
            })
            .catch(error => console.error("Ошибка:", error));
    }

    // Обработчики для кнопок "День", "Неделя" и "Месяц"
    dayBtn.addEventListener('click', function() {
        const today = moment().format('DD.MM.YYYY');
        $('#dateRangeInput').data('daterangepicker').setStartDate(today);
        $('#dateRangeInput').data('daterangepicker').setEndDate(today);
        fetchDataByRange('day');
    });
    
    weekBtn.addEventListener('click', function() {
        const endDate = moment();
        const startDate = moment().subtract(6, 'days');
        $('#dateRangeInput').data('daterangepicker').setStartDate(startDate.format('DD.MM.YYYY'));
        $('#dateRangeInput').data('daterangepicker').setEndDate(endDate.format('DD.MM.YYYY'));
        fetchDataByRange('week');
    });
    
    monthBtn.addEventListener('click', function() {
        const endDate = moment();
        const startDate = moment().subtract(29, 'days');
        $('#dateRangeInput').data('daterangepicker').setStartDate(startDate.format('DD.MM.YYYY'));
        $('#dateRangeInput').data('daterangepicker').setEndDate(endDate.format('DD.MM.YYYY'));
        fetchDataByRange('month');
    });

    // Обработчик изменения выбранной панели
    panelSelect.addEventListener('change', function() {
        const panelId = this.value;
        fetch(`/get-characteristics-data/${panelId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных панели');
                }
                return response.json();
            })
            .then(data => updateCharts(data))
            .catch(error => console.error('Ошибка запроса:', error));
    });

    // Обработчик экспорта данных в CSV
    exportDataBtn.addEventListener('click', function() {
        if (!currentData.date || !currentData.generated_power || !currentData.consumed_power) {
            alert("Нет данных для экспорта.");
            return;
        }
        const efficiency = currentData.generated_power.map((gen, i) =>
            gen > 0 ? (currentData.consumed_power[i] / gen * 100).toFixed(1) : 0
        );
        let csvContent = "data:text/csv;charset=utf-8,Date,Generated Power,Consumed Power,Efficiency\n";
        currentData.date.forEach((date, i) => {
            csvContent += `${date},${currentData.generated_power[i]},${currentData.consumed_power[i]},${efficiency[i]}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "energy_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // Инициализация daterangepicker
    $('#dateRangeInput').daterangepicker({
        locale: {
            format: 'DD.MM.YYYY',
            applyLabel: "Применить",
            cancelLabel: "Отмена",
            firstDay: 1
        }
    });

    // Загрузка начальных данных с общего эндпоинта
    fetch("/get-general-characteristics-data/")
        .then(response => {
            if (!response.ok) throw new Error('Ошибка при загрузке общих данных');
            return response.json();
        })
        .then(data => updateCharts(data))
        .catch(error => console.error('Ошибка загрузки данных:', error));
});
</script>
{% endblock %}
