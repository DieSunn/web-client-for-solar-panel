{% extends "base.html" %}
{% load static %}
{% block title %}Таблица{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/aside.css' %}">
<div class="table-container">
    <!-- Поисковая строка -->
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Поиск по таблице...">
        <button id="exportBtn" class="export-btn">Экспорт в Excel</button>
    </div>

    <!-- Фильтры -->
    <div class="filters-container">
        <select class="table-filter" id="solarPanelFilter">
            <option value="">Все установки</option>
            {% for panel in solar_panels %}
                <option value="{{ panel.id }}">Установка {{ panel.id }}</option>
            {% endfor %}
        </select>
        
        <div class="date-filter">
            <input type="date" id="dateFrom" placeholder="Дата от">
            <input type="date" id="dateTo" placeholder="Дата до">
        </div>
    </div>

    <table class="content-table" id="dataTable">
        <thead>
            <tr>
                <th class="sortable" data-sort="number">Номер установки <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="horizontal">Поворот по горизонтали <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="vertical">Поворот по вертикали <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="consumed">Потребляемая мощность <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="generated">Вырабатываемая мощность <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="date">Дата <i class='bx bx-sort-alt-2'></i></th>
                <th class="sortable" data-sort="time">Время <i class='bx bx-sort-alt-2'></i></th>
            </tr>
        </thead>
        <tbody>
            {% for char in characteristics %}
                <tr class="table-row">
                    <td>{{ char.solar_panel }}</td>
                    <td>{{ char.horizontal_position }}</td>
                    <td>{{ char.vertical_position }}</td>
                    <td>{{ char.consumed_power }}</td>
                    <td>{{ char.generated_power }}</td>
                    <td>{{ char.date }}</td>
                    <td>{{ char.time }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7">Нет данных</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Улучшенная пагинация -->
    <div class="pagination">
        <div class="pagination-controls">
            {% if characteristics.has_previous %}
                <button class="page-btn" data-page="1"><<</button>
                <button class="page-btn" data-page="{{ characteristics.previous_page_number }}"><</button>
            {% endif %}
            
            {% for num in characteristics.paginator.page_range %}
                {% if num == characteristics.number %}
                    <button class="page-btn active" data-page="{{ num }}">{{ num }}</button>
                {% elif num > characteristics.number|add:'-3' and num < characteristics.number|add:'3' %}
                    <button class="page-btn" data-page="{{ num }}">{{ num }}</button>
                {% endif %}
            {% endfor %}

            {% if characteristics.has_next %}
                <button class="page-btn" data-page="{{ characteristics.next_page_number }}">></button>
                <button class="page-btn" data-page="{{ characteristics.paginator.num_pages }}">>></button>
            {% endif %}
        </div>
        <div class="page-info">
            Страница {{ characteristics.number }} из {{ characteristics.paginator.num_pages }}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('dataTable');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('solarPanelFilter');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const exportBtn = document.getElementById('exportBtn');

    // Сортировка
    document.querySelectorAll('th.sortable').forEach(headerCell => {
        headerCell.addEventListener('click', () => {
            const columnIndex = headerCell.cellIndex;
            const rows = Array.from(table.tBodies[0].rows);
            const isNumeric = ['number', 'horizontal', 'vertical', 'consumed', 'generated'].includes(
                headerCell.dataset.sort
            );

            const direction = headerCell.classList.contains('asc') ? -1 : 1;
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                return isNumeric 
                    ? direction * (parseFloat(aValue) - parseFloat(bValue))
                    : direction * aValue.localeCompare(bValue);
            });

            table.tBodies[0].append(...rows);
            
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            headerCell.classList.toggle('asc', direction === 1);
            headerCell.classList.toggle('desc', direction === -1);
        });
    });

    // Поиск
    searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        const rows = table.getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            if (row.parentElement.tagName === 'THEAD') return;
            
            const text = Array.from(row.cells)
                .map(cell => cell.textContent.toLowerCase())
                .join(' ');
            
            row.style.display = text.includes(searchText) ? '' : 'none';
        });
    });

    // Фильтрация по датам
    function filterByDate() {
        const from = dateFrom.value;
        const to = dateTo.value;
        const rows = table.getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            if (row.parentElement.tagName === 'THEAD') return;
            
            const dateCell = row.cells[5].textContent;
            const rowDate = new Date(dateCell);
            
            const matchesDate = (!from || rowDate >= new Date(from)) && 
                              (!to || rowDate <= new Date(to));
            
            if (row.style.display !== 'none') {
                row.style.display = matchesDate ? '' : 'none';
            }
        });
    }

    dateFrom.addEventListener('change', filterByDate);
    dateTo.addEventListener('change', filterByDate);

    // Экспорт в Excel
    exportBtn.addEventListener('click', function() {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Заголовки
        const headers = Array.from(table.querySelectorAll('th'))
            .map(th => th.textContent.trim())
            .join(',');
        csvContent += headers + "\n";

        // Данные
        const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
            .filter(row => row.style.display !== 'none');

        visibleRows.forEach(row => {
            const rowData = Array.from(row.cells)
                .map(cell => cell.textContent.trim())
                .join(',');
            csvContent += rowData + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "table_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>

<style>
.table-container {
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.search-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

#searchInput {
    padding: 8px;
    width: 300px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.filters-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.table-filter {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.content-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.content-table th {
    background-color: #f4f4f4;
    padding: 12px;
    text-align: left;
    cursor: pointer;
}

.content-table th:hover {
    background-color: #e8e8e8;
}

.content-table td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
}

.table-row:hover {
    background-color: #f8f8f8;
    transition: background-color 0.3s ease;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.page-btn {
    padding: 8px 12px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.page-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.page-btn:hover:not(.active) {
    background: #f0f0f0;
}

.export-btn {
    padding: 8px 16px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.export-btn:hover {
    background: #218838;
}

th.sortable {
    position: relative;
}

th.sortable.asc::after {
    content: "↑";
    position: absolute;
    right: 8px;
}

th.sortable.desc::after {
    content: "↓";
    position: absolute;
    right: 8px;
}

.date-filter {
    display: flex;
    gap: 10px;
}

.date-filter input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>

{% endblock %}